{"ast":null,"code":"import { ElMessage } from 'element-plus';\nimport { ref, onMounted, watchEffect } from \"vue\";\nimport { getUsersAvatarPermission, getUsersAvatarFromCOS } from '@/utils/cosService';\nimport { compressImage } from '@/utils/fileService';\nexport default {\n  __name: 'ChangeAvatar',\n  props: {\n    modelValue: Boolean\n  },\n  emits: ['update:modelValue'],\n  setup(__props, {\n    expose: __expose,\n    emit: __emit\n  }) {\n    __expose();\n    const props = __props;\n    const emit = __emit;\n    const localDialogVisible = ref(props.modelValue);\n    watchEffect(() => {\n      if (localDialogVisible.value !== props.modelValue) {\n        emit('update:modelValue', localDialogVisible.value);\n      }\n    });\n    const userId = ref('');\n    const userAvatar = ref(''); //获取用户之前的头像\n\n    const fileInput = ref(null);\n    const fileName = ref();\n    const selectedImages = ref([]);\n    const imagePreviews = ref([]);\n    // const CHUNK_SIZE = 5 * 1024 * 1024;\n\n    // 当点击按钮时触发文件输入框\n    const triggerImageUpload = () => {\n      if (selectedImages.value.length < 2) {\n        fileInput.value.click();\n      } else {\n        ElMessage.error('只能提交一张照片');\n      }\n    };\n\n    // 当文件选择后处理图片\n    const handleImage = async event => {\n      const file = event.target.files[0];\n      if (file && selectedImages.value.length < 2) {\n        const timestamp = new Date().getTime(); // 获取当前时间戳\n        fileName.value = `${timestamp}-${file.name}`; // 在文件名前加时间戳\n        const compressedFile = await compressImage(file);\n        const reader = new FileReader();\n        reader.onload = function (e) {\n          imagePreviews.value.push(e.target.result);\n          selectedImages.value.push(compressedFile);\n        };\n        reader.onerror = function (e) {\n          console.error(\"Error reading file:\", e); // 错误处理\n        };\n        reader.readAsDataURL(compressedFile);\n      } else {\n        console.log(\"文件数量超标\");\n      }\n    };\n\n    //删除图片\n    const removeImage = index => {\n      selectedImages.value.splice(index, 1);\n      imagePreviews.value.splice(index, 1); // 也删除对应的预览\n    };\n\n    //修改用户头像\n    async function setUserAvater() {\n      try {\n        await getUsersAvatarPermission(selectedImages.value[0], fileName.value);\n        setTimeout(() => {\n          localDialogVisible.value = false;\n        }, 1000);\n        ElMessage.success('修改个人头像成功');\n      } catch (error) {\n        console.error(\"修改个人头像失败\", error);\n        ElMessage.error('修改个人头像失败');\n      }\n    }\n\n    // 获取用户头像\n    const fetchAvatar = async () => {\n      try {\n        userAvatar.value = await getUsersAvatarFromCOS(userId.value);\n      } catch (error) {\n        console.error(\"Error fetching user avatar:\", error);\n        ElMessage.error('获取用户头像失败');\n      }\n    };\n    onMounted(() => {\n      userId.value = localStorage.getItem(\"userId\"); // 获取用户ID\n      fetchAvatar();\n    });\n    const __returned__ = {\n      props,\n      emit,\n      localDialogVisible,\n      userId,\n      userAvatar,\n      fileInput,\n      fileName,\n      selectedImages,\n      imagePreviews,\n      triggerImageUpload,\n      handleImage,\n      removeImage,\n      setUserAvater,\n      fetchAvatar,\n      get ElMessage() {\n        return ElMessage;\n      },\n      ref,\n      onMounted,\n      watchEffect,\n      get getUsersAvatarPermission() {\n        return getUsersAvatarPermission;\n      },\n      get getUsersAvatarFromCOS() {\n        return getUsersAvatarFromCOS;\n      },\n      get compressImage() {\n        return compressImage;\n      }\n    };\n    Object.defineProperty(__returned__, '__isScriptSetup', {\n      enumerable: false,\n      value: true\n    });\n    return __returned__;\n  }\n};","map":{"version":3,"names":["ElMessage","ref","onMounted","watchEffect","getUsersAvatarPermission","getUsersAvatarFromCOS","compressImage","props","__props","emit","__emit","localDialogVisible","modelValue","value","userId","userAvatar","fileInput","fileName","selectedImages","imagePreviews","triggerImageUpload","length","click","error","handleImage","event","file","target","files","timestamp","Date","getTime","name","compressedFile","reader","FileReader","onload","e","push","result","onerror","console","readAsDataURL","log","removeImage","index","splice","setUserAvater","setTimeout","success","fetchAvatar","localStorage","getItem"],"sources":["D:/有渔/前端源码/YouyuBBS-Q - 副本/youyu-lyn-qtnew-vision-new-2024.1.14/src/page/TheSettings/components/ChangeAvatar.vue"],"sourcesContent":["<template>\r\n  <div>\r\n    <el-dialog v-model=\"localDialogVisible\" :title=\"'修改头像'\" style=\"width: 60%; height: 60%; \">\r\n        <div class=\"container\">\r\n            <!-- 更换头像 -->\r\n            <div class=\"coverage\">\r\n                <!-- <span class=\"pictext\">封面</span> -->\r\n                <div class=\"beforepic\">\r\n                  <img  :src=\"userAvatar\" alt=\"\" style=\"width: 180px; height: 180px; border-radius: 10px;\">\r\n                  <span>(之前使用的头像)</span>\r\n                </div>\r\n                <div class=\"afterpic\">\r\n                  <div class=\"picshow\">\r\n                    <input type=\"file\" ref=\"fileInput\" accept=\"image/*\" style=\"display: none;\" @change=\"handleImage\" />\r\n                    <div  class=\"tpic\" >\r\n                        <el-icon @click=\"triggerImageUpload\" style=\"position: absolute; left: 70px; top: 70px;font-size: 40px;cursor: pointer;\"><Plus /></el-icon>\r\n                    </div>\r\n                    <div class=\"pic_contain\">\r\n                      <div v-for=\"(imagePreview, index) in imagePreviews\" :key=\"index\" class=\"spic\" :style=\"{ backgroundImage: `url(${imagePreview})` }\">\r\n                        <el-icon class=\"delete-btn\" @click=\"removeImage(index)\"><CircleCloseFilled /></el-icon>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                  <span>(您要修改后的头像)</span>\r\n                </div>\r\n            </div>\r\n        </div>\r\n        <template #footer>\r\n        <span class=\"dialog-footer\">\r\n            <el-button @click=\"localDialogVisible = false\">Cancel</el-button>\r\n            <el-button type=\"primary\" @click =\"setUserAvater\">\r\n            提交\r\n            </el-button>\r\n        </span>\r\n        </template>\r\n    </el-dialog>\r\n  </div>\r\n</template>\r\n\r\n<script setup>\r\nimport { ElMessage } from 'element-plus';\r\nimport {ref,defineProps,onMounted,watchEffect,defineEmits} from \"vue\";\r\nimport { getUsersAvatarPermission,getUsersAvatarFromCOS } from '@/utils/cosService';\r\nimport {compressImage} from '@/utils/fileService';\r\n\r\nconst props = defineProps({\r\n    modelValue: Boolean,\r\n});\r\n\r\nconst emit = defineEmits(['update:modelValue']);\r\nconst localDialogVisible = ref(props.modelValue);\r\nwatchEffect(() => {\r\n  if (localDialogVisible.value !== props.modelValue) {\r\n    emit('update:modelValue', localDialogVisible.value);\r\n  }\r\n});\r\n\r\nconst userId = ref('');\r\nconst userAvatar = ref('')//获取用户之前的头像\r\n\r\nconst fileInput = ref(null);\r\nconst fileName = ref();\r\nconst selectedImages = ref([]);\r\nconst imagePreviews = ref([]);\r\n// const CHUNK_SIZE = 5 * 1024 * 1024;\r\n\r\n\r\n\r\n// 当点击按钮时触发文件输入框\r\nconst triggerImageUpload = () => {\r\n  if (selectedImages.value.length < 2) {\r\n    fileInput.value.click();\r\n  } else {\r\n    ElMessage.error('只能提交一张照片');\r\n  }\r\n};\r\n\r\n// 当文件选择后处理图片\r\nconst handleImage = async (event) => {\r\n  const file = event.target.files[0];\r\n  if (file && selectedImages.value.length < 2) {\r\n    const timestamp = new Date().getTime(); // 获取当前时间戳\r\n    fileName.value = `${timestamp}-${file.name}`; // 在文件名前加时间戳\r\n    const compressedFile = await compressImage(file);\r\n    const reader = new FileReader();\r\n    reader.onload = function(e) {\r\n      imagePreviews.value.push(e.target.result);\r\n      selectedImages.value.push(compressedFile);\r\n    };\r\n    reader.onerror = function(e) {\r\n      console.error(\"Error reading file:\", e); // 错误处理\r\n    };\r\n    reader.readAsDataURL(compressedFile);\r\n  } else {\r\n    console.log(\"文件数量超标\"); \r\n  }\r\n};\r\n\r\n\r\n//删除图片\r\nconst removeImage = (index) => {\r\n    selectedImages.value.splice(index, 1);\r\n    imagePreviews.value.splice(index, 1);  // 也删除对应的预览\r\n};\r\n\r\n//修改用户头像\r\nasync function setUserAvater() {\r\n  try {\r\n    await getUsersAvatarPermission(selectedImages.value[0],fileName.value);\r\n    setTimeout(() => {\r\n      localDialogVisible.value= false;\r\n    }, 1000);\r\n    ElMessage.success('修改个人头像成功');\r\n  } catch (error) {\r\n      console.error(\"修改个人头像失败\", error); \r\n      ElMessage.error('修改个人头像失败');\r\n  }\r\n}\r\n\r\n// 获取用户头像\r\nconst fetchAvatar = async () => {\r\n  try {\r\n    userAvatar.value = await getUsersAvatarFromCOS(userId.value);\r\n  } catch (error) {\r\n    console.error(\"Error fetching user avatar:\", error);\r\n    ElMessage.error('获取用户头像失败');\r\n  }\r\n};\r\n\r\nonMounted(() => {\r\n  userId.value = localStorage.getItem(\"userId\"); // 获取用户ID\r\n  fetchAvatar();\r\n});\r\n\r\n</script>\r\n\r\n<style scoped>\r\n.container{\r\n    display: flex;\r\n    flex-direction: column;\r\n    gap: 30px;\r\n}\r\n.coverage{\r\n    display: flex;\r\n    justify-content: space-evenly;\r\n    gap: 20px;\r\n    width: 100%;\r\n    height: 180px;\r\n}\r\n.beforepic,\r\n.afterpic {\r\n    display: flex;\r\n    gap: 10px;\r\n    align-items: flex-end;\r\n}\r\n.picshow {\r\n    width: 180px;\r\n    height: 180px;\r\n    border: 1px dashed #bbbbbb;\r\n    border-radius: 10px;\r\n    cursor: pointer;\r\n    position: relative;\r\n}\r\n.spic{\r\n    background-size: cover;\r\n    background-repeat: no-repeat;\r\n    background-position: center center;\r\n    width: 180px;\r\n    height: 180px;\r\n}\r\n.pic_contain{\r\n  position: relative;\r\n}\r\ni.delete-btn {\r\n  position: absolute;\r\n  right: 5px;\r\n  top: 8px;\r\n  cursor: pointer;\r\n}\r\n/* .avatar-uploader{\r\n    width: 90%;\r\n    border-radius: 10px\r\n}\r\n.avatar-uploader .avatar {\r\n  width: 150px;\r\n  height: 150px;\r\n  display: block;\r\n}\r\n.avatar-uploader .el-upload {\r\n  border: 1px dashed var(--el-border-color);\r\n  border-radius: 6px;\r\n  cursor: pointer;\r\n  position: relative;\r\n  overflow: hidden;\r\n  transition: var(--el-transition-duration-fast);\r\n}\r\n\r\n.avatar-uploader .el-upload:hover {\r\n  border-color: var(--el-color-primary);\r\n}\r\n.el-upload-list--picture-card{\r\n  --el-upload-list-picture-card-size: 150px;\r\n}\r\n.el-icon.avatar-uploader-icon {\r\n  font-size: 28px;\r\n  color: #8c939d;\r\n  width: 150px;\r\n  height: 150px;\r\n  text-align: center;\r\n} */\r\n\r\n::v-deep .el-dialog__body {\r\n  padding: 0px var(--el-dialog-padding-primary);\r\n}\r\n::v-deep .el-dialog__header{\r\n  padding-bottom: 20px;\r\n}\r\n::v-deep .el-dialog__footer {\r\n  padding: 0px;\r\n  position: absolute;\r\n  right: 15px;\r\n  bottom: 10px;\r\n}\r\n::v-deep .el-input ,\r\n::v-deep .el-textarea{\r\n  width: 90%;\r\n}\r\n/* 三个输入框边框样式 */\r\n::v-deep .el-input__wrapper,\r\n::v-deep .el-textarea__inner{\r\n  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);\r\n}\r\n::v-deep .el-input__wrapper{\r\n  height: 40px;\r\n}  \r\n::v-deep .el-textarea__inner{\r\n  height: 130px;\r\n}  \r\n/* 三个输入框获得焦点时的边框样式 */\r\n::v-deep .el-input__wrapper.is-focus,\r\n::v-deep .el-textarea__inner:focus{\r\n  box-shadow: 0 2px 6px #cfd7e2;\r\n  border: 1px solid #d7d7d7;\r\n}\r\n.input_el textarea {\r\n  overflow: hidden;\r\n}\r\n.dialog-footer button:first-child {\r\n  margin-right: 10px;\r\n}\r\n\r\n</style>"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}