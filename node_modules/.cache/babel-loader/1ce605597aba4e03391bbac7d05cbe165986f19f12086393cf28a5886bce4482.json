{"ast":null,"code":"import { ref, onMounted } from 'vue';\nimport axios from '@/utils/request';\nimport { fetchShareCoverage } from '@/utils/fileService';\nimport { ElMessage } from 'element-plus';\nimport { convertDateFormat } from '@/utils/timeFormat';\nimport ShareDialog from '../../ShareShow/components/ShareDialog.vue';\nimport { useRouter } from 'vue-router';\nimport { getUsersAvatarFromCOS, getArticleCoverageFromCOS } from '@/utils/cosService';\nimport { openUrl } from '@/utils/routeJudge';\nexport default {\n  __name: 'AllContentComponent',\n  setup(__props, {\n    expose: __expose\n  }) {\n    __expose();\n    const currentPage = ref(1);\n    const router = useRouter();\n    const userId = parseInt(localStorage.getItem(\"userId\")); // 获取用户ID\n    const articleData = ref([]);\n    const shareId = ref();\n    const dialogShowVisible = ref(false); //控制分享展示弹框是否展示\n\n    // 添加一个锁状态\n    let isLoading = false;\n    async function load() {\n      if (isLoading) return; // 如果已经在加载中，则直接返回不执行新的加载\n      isLoading = true; // 开始加载数据，设置锁状态为true\n      try {\n        if (currentPage.value === 1) {\n          currentPage.value++;\n        }\n        await getDynamicData(currentPage.value);\n        currentPage.value++; // 只有在请求成功完成后才递增页码\n      } catch (error) {\n        console.error(error);\n        ElMessage.error('滚动时的未知错误');\n      } finally {\n        isLoading = false; // 请求完成，无论成功或失败，都释放锁状态\n      }\n    }\n\n    // 获取分享和文章数据\n    async function getDynamicData(currentPage) {\n      try {\n        const response = await axios.get(`/users/works`, {\n          params: {\n            userId: userId,\n            page: currentPage,\n            pageSize: 10,\n            type: 2\n          }\n        });\n        if (response.data.code === 1 && response.data.data.records.length > 0) {\n          const updates = response.data.data.records.map(async record => {\n            const avatar = await getUsersAvatarFromCOS(record.userId);\n            const createTime = convertDateFormat(record.createTime);\n            let newCoverPicture;\n            if (record.type === 0) {\n              newCoverPicture = await getArticleCoverageFromCOS(record.id);\n            } else if (record.type === 1) {\n              newCoverPicture = await fetchShareCoverage(record.id);\n            }\n            return {\n              ...record,\n              avatar,\n              createTime,\n              newCoverPicture\n            };\n          });\n          const updatedRecords = await Promise.all(updates);\n          articleData.value = [...articleData.value, ...updatedRecords];\n          // ElMessage.success('获取用户动态成功');\n        } else if (response.data.code === 1 && response.data.data.records.length === 0) {\n          // ElMessage.info('已加载所有数据');\n        } else if (response.data.code === 0 && response.data.msg) {\n          ElMessage.error(response.data.msg.toString());\n        } else {\n          console.error(\"获取用户动态失败\");\n          ElMessage.error('获取用户动态失败');\n        }\n      } catch (error) {\n        console.error(\"获取用户动态失败\", error);\n        ElMessage.error('获取用户动态失败');\n      }\n    }\n    const goToDetail = item => {\n      if (item.type === 0) {\n        // const routeLocation = router.resolve({ path: `/TheArticle/${item.id}`});\n        // window.open(routeLocation.href, '_blank');\n        openUrl(`/TheArticle/${item.id}`);\n      } else if (item.type === 1) {\n        shareId.value = item.id;\n        dialogShowVisible.value = true;\n      }\n    };\n    onMounted(() => {\n      getDynamicData(currentPage.value);\n    });\n    const __returned__ = {\n      currentPage,\n      router,\n      userId,\n      articleData,\n      shareId,\n      dialogShowVisible,\n      get isLoading() {\n        return isLoading;\n      },\n      set isLoading(v) {\n        isLoading = v;\n      },\n      load,\n      getDynamicData,\n      goToDetail,\n      ref,\n      onMounted,\n      get axios() {\n        return axios;\n      },\n      get fetchShareCoverage() {\n        return fetchShareCoverage;\n      },\n      get ElMessage() {\n        return ElMessage;\n      },\n      get convertDateFormat() {\n        return convertDateFormat;\n      },\n      ShareDialog,\n      get useRouter() {\n        return useRouter;\n      },\n      get getUsersAvatarFromCOS() {\n        return getUsersAvatarFromCOS;\n      },\n      get getArticleCoverageFromCOS() {\n        return getArticleCoverageFromCOS;\n      },\n      get openUrl() {\n        return openUrl;\n      }\n    };\n    Object.defineProperty(__returned__, '__isScriptSetup', {\n      enumerable: false,\n      value: true\n    });\n    return __returned__;\n  }\n};","map":{"version":3,"names":["ref","onMounted","axios","fetchShareCoverage","ElMessage","convertDateFormat","ShareDialog","useRouter","getUsersAvatarFromCOS","getArticleCoverageFromCOS","openUrl","currentPage","router","userId","parseInt","localStorage","getItem","articleData","shareId","dialogShowVisible","isLoading","load","value","getDynamicData","error","console","response","get","params","page","pageSize","type","data","code","records","length","updates","map","record","avatar","createTime","newCoverPicture","id","updatedRecords","Promise","all","msg","toString","goToDetail","item"],"sources":["D:/有渔/前端源码/YouyuBBS-Q - 副本/youyu-lyn-qtnew-vision-new-2024.1.14/src/page/Personalpage/dynamic/AllContentComponent.vue"],"sourcesContent":["<template>\r\n  <div class=\"main_1\">\r\n    <div class=\"pageshow\"  v-infinite-scroll=\"load\" infinite-scroll-distance=\"100\" infinite-scroll-immediate=\"false\">\r\n      <el-timeline>\r\n        <el-timeline-item\r\n          v-for=\"item in articleData\"\r\n          :key=\"item.id\"\r\n          :timestamp=\"item.createTime\"\r\n          placement=\"top\"\r\n          @click=\"goToDetail(item)\"\r\n        >\r\n          <el-card>\r\n            <div class=\"card\">\r\n              <div style=\"display: flex;flex-direction: column;\">\r\n                <h1 class=\"phtitle\">{{ item.title }}</h1>\r\n                <p v-if=\"item.type === 0\" class=\"chtitle multi-line-ellipsis-4\">{{ item.summary }}</p>  \r\n                <p v-if=\"item.type === 1\" class=\"chtitle2 multi-line-ellipsis-4\">{{ item.content }}</p>  \r\n                <!-- 分享图片 -->\r\n                <div v-if=\"item.type === 1\">\r\n                  <img \r\n                    v-for= \"(image, imgIndex) in item.newCoverPicture.slice(0, 1)\"  \r\n                    :src='image' \r\n                    :key=\"imgIndex\" \r\n                    alt=\"Share Image\"\r\n                    class=\"pic2\"\r\n                  />  \r\n                </div>  \r\n                <div class=\"icon_container\">\r\n                  <div class=\"cri\">\r\n                    <img class=\"like-pic\" src=\"@/assets/LikeBefore.svg\" />\r\n                    <span class=\"cname\">{{ item.likeCount }}</span>\r\n                  </div>\r\n                  <div class=\"cri\">\r\n                    <img class=\"like-pic\" src=\"@/assets/Comment.svg\" />\r\n                    <span class=\"cname\">{{ item.commentCount }}</span>\r\n                  </div>\r\n                  <div class=\"cri\">\r\n                    <img class=\"like-pic\" src=\"@/assets/Transpond.svg\" />\r\n                    <span class=\"cname\">{{ item.transmitCount }}</span>\r\n                  </div>\r\n                  <div class=\"cri\">\r\n                    <img class=\"like-pic\" src=\"@/assets/FavoriteBefore.svg\" />\r\n                    <span class=\"cname\">{{ item.favoriteCount }}</span>\r\n                  </div>\r\n                </div> \r\n              </div>\r\n              <!-- 文章封面图片 -->\r\n              <div v-if=\"item.type === 0\">\r\n                <img \r\n                  :src='item.newCoverPicture'  \r\n                  :key=\"imgIndex\" \r\n                  alt=\"Share Image\"\r\n                  class=\"pic\"\r\n                />  \r\n              </div>   \r\n            </div>\r\n          </el-card>\r\n        </el-timeline-item>\r\n      </el-timeline>\r\n      <el-empty \r\n          v-if=\"articleData.length === 0 || !articleData\" \r\n          :image-size=\"200\" \r\n          description=\"您还没有动态呢，快去创作吧！\"\r\n      />\r\n    </div>\r\n  </div>\r\n  <div v-if=\"dialogShowVisible\">\r\n      <ShareDialog v-model=\"dialogShowVisible\" :Id = ShareId ></ShareDialog>\r\n  </div>\r\n</template>\r\n\r\n<script setup>\r\n    import { ref,onMounted} from 'vue';\r\n    import axios from '@/utils/request';\r\n    import { fetchShareCoverage } from '@/utils/fileService'; \r\n    import { ElMessage } from 'element-plus';\r\n    import { convertDateFormat } from '@/utils/timeFormat'; \r\n    import ShareDialog from '../../ShareShow/components/ShareDialog.vue';\r\n    import { useRouter } from 'vue-router';\r\n    import { getUsersAvatarFromCOS,getArticleCoverageFromCOS } from '@/utils/cosService';\r\n    import { openUrl } from '@/utils/routeJudge'\r\n\r\n    const currentPage = ref(1);\r\n    const router = useRouter();\r\n    const userId = parseInt(localStorage.getItem(\"userId\")); // 获取用户ID\r\n    const articleData = ref([]);\r\n    const shareId = ref();\r\n    const dialogShowVisible = ref(false);//控制分享展示弹框是否展示\r\n\r\n    // 添加一个锁状态\r\n    let isLoading = false;\r\n    async function load() {\r\n        if (isLoading) return; // 如果已经在加载中，则直接返回不执行新的加载\r\n        isLoading = true; // 开始加载数据，设置锁状态为true\r\n        try {\r\n          if(currentPage.value === 1){\r\n              currentPage.value++;\r\n          }\r\n          await getDynamicData(currentPage.value);\r\n          currentPage.value++; // 只有在请求成功完成后才递增页码\r\n        } catch (error) {\r\n            console.error(error);\r\n            ElMessage.error('滚动时的未知错误');\r\n        } finally {\r\n            isLoading = false; // 请求完成，无论成功或失败，都释放锁状态\r\n        }\r\n    }\r\n\r\n    // 获取分享和文章数据\r\n    async function getDynamicData(currentPage) {\r\n      try{\r\n        const response = await axios.get(`/users/works`,{\r\n            params: {\r\n                userId:userId,\r\n                page:currentPage,\r\n                pageSize:10,\r\n                type:2,\r\n            }\r\n        });\r\n        if (response.data.code === 1 && response.data.data.records.length > 0) {\r\n          const updates = response.data.data.records.map(async (record) => {\r\n            const avatar = await getUsersAvatarFromCOS(record.userId);\r\n            const createTime = convertDateFormat(record.createTime);\r\n            let newCoverPicture;\r\n            if (record.type === 0) {\r\n              newCoverPicture = await getArticleCoverageFromCOS(record.id);\r\n            } else if (record.type === 1) {\r\n              newCoverPicture = await fetchShareCoverage(record.id);\r\n            }\r\n            return {\r\n              ...record,\r\n              avatar,\r\n              createTime,\r\n              newCoverPicture\r\n            };\r\n          });\r\n          const updatedRecords = await Promise.all(updates);\r\n          articleData.value = [...articleData.value, ...updatedRecords];\r\n          // ElMessage.success('获取用户动态成功');\r\n        }else if (response.data.code === 1 && response.data.data.records.length === 0) {\r\n          // ElMessage.info('已加载所有数据');\r\n        }else if(response.data.code === 0 && response.data.msg){\r\n            ElMessage.error(response.data.msg.toString());\r\n        }else{\r\n            console.error(\"获取用户动态失败\");\r\n            ElMessage.error('获取用户动态失败');\r\n        }\r\n      } catch (error) {\r\n        console.error(\"获取用户动态失败\", error); \r\n        ElMessage.error('获取用户动态失败');\r\n      }\r\n    }\r\n\r\n    const goToDetail = (item) =>{\r\n      if(item.type === 0){\r\n          // const routeLocation = router.resolve({ path: `/TheArticle/${item.id}`});\r\n          // window.open(routeLocation.href, '_blank');\r\n          openUrl(`/TheArticle/${item.id}`)\r\n      }\r\n      else if(item.type === 1){\r\n          shareId.value = item.id;\r\n          dialogShowVisible.value = true\r\n      }\r\n    }\r\n  \r\n    onMounted(() => {\r\n      getDynamicData(currentPage.value);\r\n    })\r\n\r\n</script>\r\n\r\n\r\n\r\n<style scoped>\r\n.main_1 {\r\n  display: flex;\r\n  padding-left: 0px;\r\n  flex-direction: column;\r\n  align-items: flex-start;\r\n  flex-shrink: 0;\r\n  min-height: 225px;\r\n}\r\n.pageshow {\r\n  width: 90%;\r\n  gap: 12px;\r\n  margin: 30px auto 0px;\r\n  min-height: 100px;\r\n}\r\n.card{\r\n  display: flex;\r\n  justify-content: space-between;\r\n  align-items: center;\r\n}\r\n.phtitle {\r\n  color: #000;\r\n  font-family: Microsoft YaHei;\r\n  font-size: 16px;\r\n  font-style: normal;\r\n  font-weight: 700;\r\n  line-height: 120%; \r\n}\r\n.chtitle {\r\n  min-height: 58px;\r\n  width: 500px;\r\n  line-height: 1.6;\r\n  font-size: 14px;\r\n}\r\n.pic2{\r\n  width: 182px;\r\n  height: 160px;\r\n  border-radius: 8px;\r\n  border: 1px solid #ebebeb;\r\n}\r\n.icon_container {\r\n  display: flex;\r\n  gap: 20px;\r\n  width: 500px;\r\n  margin-top: 20px;\r\n}\r\n.cri {\r\n  display: flex;\r\n  gap: 4px;\r\n}\r\n.like-pic {\r\n  display: block;      \r\n  margin: auto;        \r\n  height: 16px;\r\n  width: 16px;\r\n  margin-right: 2px;\r\n  cursor: pointer;\r\n}\r\n.pic{\r\n  width: 200px;\r\n  height: 140px;\r\n  flex-shrink: 0;\r\n  border-radius: 8px;\r\n}\r\n\r\n.cname {\r\n  color: #2d2d2d;\r\n  font-size: 13px;\r\n  line-height: 120%;\r\n}\r\n.chtitle2 {\r\n  min-height: 25px;\r\n  width: 800px;\r\n  line-height: 1.6;\r\n  font-size: 14px;\r\n}\r\n</style>\r\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}